# SNUBH Work Flow
환자 이동 거리, 시간 산출


1. 소개

데이터를 받아 출발지부터 도착지까지 특정 시간에 이동했을 때의 거리와 시간을 산출하는 프로그램이다. 데이터의 형태로는 ‘병원주소지’, ‘환자주소지’, ‘arrival’의 칼럼을 가지고 있는 데이터이다. 이 때, ‘환자주소지’가 출발점이 되고 ‘병원주소지’가 도착점이 된다. ‘arrival’은 출발 시점을 나타내는 ‘2023-01-01 09:21:00’ 형태의 데이터이다. 받은 데이터에서 ‘검색 결과’, ‘이동 거리’, ‘이동 시간’이라는 새로운 칼럼을 만들어 연산된 결과물을 저장하여 내보낸다.

이동 거리와 시간을 산출하기 위해서 Kakao API의 ‘미래 운행 정보 길찾기’를 사용하였다. 해당 API는 출발점, 도착점의 위도, 경도를 필요로 한다. 이를 위해 주소지를 geocode로 변환하기 위해 Kakao Maps API ‘Local’을 사용하여 좌표로 변환하는 작업을 거쳤다.

변환에 성공한 좌표들은 ‘미래 운행 정보 길찾기’ API를 통해 거리와 시간 산출을 완료하였다. ‘arrival’에서 요일과 시간을 추출하여 출발 시간을 지정하였으며 하이패스를 허용하도록 설정하였다. 도출된 결과물은 ‘검색 결과’, ‘이동 거리’, ‘이동 시간’에 저장된다.

‘검색 결과’는 3가지 유형으로 나뉜다. 첫 번째는 ‘검색 성공’이다. 거리와 시간 산출이 정상적으로 진행되었다는 의미이다. 두 번째는 ‘검색 실패’이다. 기재된 주소가 오탈자, 혹은 과거에는 존재했지만 사라진 주소 등의 다양한 이유로 길찾기 검색이 실패된 경우이다. 세 번째는 ‘주소 미기재’이다. 잘못된 주소로 인한 ‘검색 실패’와는 달리, 애초부터 아예 주소를 기재하지 않아 검색에 실패한 경우이다. ‘이동 거리’의 단위를 ‘m’이고, ‘이동 시간’의 단위는 ‘분’이다.

2. 주소 전처리

주소지 전처리 없이 검색 시 실패율이 80% 이상이다. ‘검색 실패’한 이유는 주소지를 geocode로 변환하지 못해서이다. 그렇기에 주소지를 geocode로 성공적으로 변환하도록 수정하는 알고리즘을 제작하여 수정 후 해당 프로그램을 다시 적용하였다. 도착지(병원)와 출발지(환자)의 주소 중에서 도착지는 제주병원을 제외하고 모두 성공적으로 geocode로 변환되었다. 제주병원의 경우, ‘아란13길’이 ‘아라13길’로 오타가 난 것이 원인이어서 해당부분은 수작업으로 변경하였다. 출발지의 경우 geocode로 변환되지 않은 이유를 다음과 같이 분석했다.

a) 주소 뒷부분에 괄호가 있는 경우 ex) 서울시 관악구 숭실로 123 (대학동,숭실아파트)

b) ‘길’/’로’ + (숫자) 조합 뒤에 불필요한 상세주소가 더 붙은 경우 ex) 서울 관악구 남부순환로 123, 456호 (컴학동, 숭실아파트)

c) 주소에 특수문자가 붙은 경우 ex) ’-’, ‘/’

d) 오타가 있는 경우 ex) “경남 거차군위천면 ~” 거차군 → 거창군

e) 기타 (특정 이유가 파악되지 않는 경우)

위와 같이 다양한 이유로 geocode로 변환되지 않은 주소들은 다음과 같은 과정을 거쳐 주소지를 전처리하였다.

괄호 포함 뒷부분 제거
‘길’/’로’ + (숫자) 조합인 경우 그 뒷부분 제거
특수 문자 제거
동, 호 제거
키워드 검색
이 중 5번, 키워드 검색의 경우 주소 검색 API가 아닌 키워드 장소 검색 API를 사용하여 좌표를 알아내는 방식이다. 위 과정을 거쳤음에도 geocode로 변환 실패한 주소지들은 성공률을 높이기 위해 Google Maps API도 사용하였다. Kakao 지도에서 검색되지 않았던 주소가 Google 지도에서는 검색되는 경우가 있었기 때문이다. Google Maps API를 사용할 때는 위의 수정 작업을 거치지 않은 원본의 주소를 이용하여 geocode로 변환하는 작업을 수행하였다. ‘검색 실패’한 주소지에 한 해 위와 같은 전처리 과정을 거친 후 Kakao API ‘미래 운행 정보 길찾기’를 이용하여 이동 거리와 시간을 다시 산출하였다.

3. 플로우 차트

![SNUBH 워크플로우-001](https://user-images.githubusercontent.com/83453646/221283973-62be0c77-7877-4edd-bb60-91b5f8219bae.png)

4. 함수 코드 설명

a) address_to_xy

주소지 문자열을 입력으로 받아 카카오 API를 사용하여 geocode로 변환한 후, x, y를 리턴해준다.
x,y 리턴에 실패한 경우, 아래 2) 함수를 실행시킨다.

b) keyword_search

주소지와 데이터의 인덱스를 입력으로 받아 주소지 전처리 알고리즘을 수행 후 geocode로 변환하여 x, y를 리턴해준다.
또한 그렇게 보정한 주소를 해당 인덱스의 데이터에 저장한다.
x,y 리턴에 실패한 경우, 아래 3) 함수를 실행시킨다.

c) google_maps_geocoding

주소지 문자열을 입력으로 받아 구글 API를 사용하여 geocode로 변환한 후, x, y를 리턴해준다.
